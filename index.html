<!DOCTYPE html>
<html>
<body>
<video id="video" autoplay></video>
<canvas id="canvas"></canvas>

<script>
const ws = new WebSocket(`wss://${location.host}/ws`);
const video = document.getElementById("video");
const canvas = document.getElementById("canvas");
const ctx = canvas.getContext("2d");

navigator.mediaDevices.getUserMedia({ video: true })
.then(stream => video.srcObject = stream);

ws.onmessage = e => {
  const boxes = JSON.parse(e.data);
  boxes.forEach(b=>{
    ctx.strokeStyle="red";
    ctx.strokeRect(b.x1,b.y1,b.x2-b.x1,b.y2-b.y1);
    ctx.fillText(b.cls,b.x1,b.y1-5);
  });
};

setInterval(()=>{
  canvas.width = video.videoWidth;
  canvas.height = video.videoHeight;
  ctx.drawImage(video,0,0);
  canvas.toBlob(blob=>{
    const r = new FileReader();
    r.onloadend = ()=> ws.send(r.result.split(",")[1]);
    r.readAsDataURL(blob);
  });
}, 200);
</script>
</body>
</html>
